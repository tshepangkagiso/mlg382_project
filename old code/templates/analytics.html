<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Churn Analytics Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="/static/css/styles.css" rel="stylesheet">
    <style>
        .analytics-section {
            margin-bottom: 3rem;
        }
        .table-responsive {
            max-height: 500px;
            overflow-y: auto;
        }
        .metric-card {
            border-left: 4px solid #4e73df;
            margin-bottom: 1.5rem;
        }
        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .metric-label {
            color: #5a5c69;
            font-weight: 500;
        }
        .classification-table td, .classification-table th {
            text-align: center;
        }
        .high-risk {
            background-color: rgba(231, 74, 59, 0.15);
        }
        .back-btn {
            margin-bottom: 1.5rem;
        }
        .back-btn i {
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <header class="dashboard-header">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h1><i class="bi bi-bar-chart-line"></i> Churn Analytics Dashboard</h1>
                    </div>
                    <div class="col-md-6 text-end">
                        <span class="badge bg-primary">Model Performance</span>
                    </div>
                </div>
            </div>
        </header>

        <main class="dashboard-content">
            <div class="container">
                <div class="row">
                    <div class="col-12">
                        <a href="/" class="btn btn-outline-primary back-btn">
                            <i class="bi bi-arrow-left"></i> Back to Predictor
                        </a>
                    </div>
                </div>
                
                <!-- Confusion Matrix Section -->
                <div class="row analytics-section">
                    <div class="col-lg-12">
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="bi bi-grid-3x3"></i> Confusion Matrix</h3>
                            </div>
                            <div class="card-body text-center">
                                {% if confusion_matrix_img %}
                                <img src="data:image/png;base64,{{ confusion_matrix_img }}" alt="Confusion Matrix" class="img-fluid">
                                {% else %}
                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle"></i>
                                    Confusion matrix not available. Make sure test data includes true labels.
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Classification Report Section -->
                <div class="row analytics-section">
                    <div class="col-lg-12">
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="bi bi-clipboard-data"></i> Classification Report</h3>
                            </div>
                            <div class="card-body">
                                {% if classification_report %}
                                <div class="table-responsive">
                                    <table class="table table-bordered classification-table">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Class</th>
                                                <th>Precision</th>
                                                <th>Recall</th>
                                                <th>F1-Score</th>
                                                <th>Support</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for class_name, metrics in classification_report.items() %}
                                                {% if class_name not in ['accuracy', 'macro avg', 'weighted avg'] %}
                                                <tr>
                                                    <td>{{ class_name }}</td>
                                                    <td>{{ "%.2f"|format(metrics['precision'] * 100) }}%</td>
                                                    <td>{{ "%.2f"|format(metrics['recall'] * 100) }}%</td>
                                                    <td>{{ "%.2f"|format(metrics['f1-score'] * 100) }}%</td>
                                                    <td>{{ metrics['support'] }}</td>
                                                </tr>
                                                {% endif %}
                                            {% endfor %}
                                        </tbody>
                                        <tfoot class="table-light">
                                            {% if 'accuracy' in classification_report %}
                                            <tr>
                                                <td colspan="3" class="text-end"><strong>Accuracy:</strong></td>
                                                <td colspan="2">{{ "%.2f"|format(classification_report['accuracy'] * 100) }}%</td>
                                            </tr>
                                            {% endif %}
                                            {% if 'macro avg' in classification_report %}
                                            <tr>
                                                <td><strong>Macro Avg</strong></td>
                                                <td>{{ "%.2f"|format(classification_report['macro avg']['precision'] * 100) }}%</td>
                                                <td>{{ "%.2f"|format(classification_report['macro avg']['recall'] * 100) }}%</td>
                                                <td>{{ "%.2f"|format(classification_report['macro avg']['f1-score'] * 100) }}%</td>
                                                <td>{{ classification_report['macro avg']['support'] }}</td>
                                            </tr>
                                            {% endif %}
                                            {% if 'weighted avg' in classification_report %}
                                            <tr>
                                                <td><strong>Weighted Avg</strong></td>
                                                <td>{{ "%.2f"|format(classification_report['weighted avg']['precision'] * 100) }}%</td>
                                                <td>{{ "%.2f"|format(classification_report['weighted avg']['recall'] * 100) }}%</td>
                                                <td>{{ "%.2f"|format(classification_report['weighted avg']['f1-score'] * 100) }}%</td>
                                                <td>{{ classification_report['weighted avg']['support'] }}</td>
                                            </tr>
                                            {% endif %}
                                        </tfoot>
                                    </table>
                                </div>
                                {% else %}
                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle"></i>
                                    Classification report not available. Make sure test data includes true labels.
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Potential Churners Section -->
                <div class="row analytics-section">
                    <div class="col-lg-12">
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="bi bi-person-x"></i> Potential Churners</h3>
                            </div>
                            <div class="card-body">
                                {% if potential_churners %}
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead>
                                            <tr>
                                                {% for column in potential_churners[0].keys() %}
                                                <th>{{ column }}</th>
                                                {% endfor %}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for customer in potential_churners %}
                                            <tr class="{% if customer['Churn_Probability'] > 0.7 %}high-risk{% endif %}">
                                                {% for key, value in customer.items() %}
                                                <td>
                                                    {% if key == 'Churn_Probability' %}
                                                    {{ "%.2f"|format(value * 100) }}%
                                                    {% else %}
                                                    {{ value }}
                                                    {% endif %}
                                                </td>
                                                {% endfor %}
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% else %}
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i>
                                    No potential churners found in the test dataset.
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer class="dashboard-footer">
            <div class="container">
                <div class="row">
                    <div class="col-md-6">
                        <p>Â© 2023 Churn Prediction AI. All rights reserved.</p>
                    </div>
                    <div class="col-md-6 text-end">
                        <p>Model accuracy: {% if classification_report and 'accuracy' in classification_report %}{{ "%.1f"|format(classification_report['accuracy'] * 100) }}%{% else %}82.5%{% endif %}</p>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>